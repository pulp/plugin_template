{% include 'header.j2' %}
{% from 'macros.j2' import
  set_env_vars,
  checkout,
  setup_python,
  setup_ruby,
  install_httpie,
  after_failure,
  run_script,
  set_secrets,
  install_python_deps,
with context %}
---
name: {{ plugin_camel_short | default("Pulp") }} CI
on: {{ ci_trigger | default("{pull_request: {branches: ['*']}}") }}
jobs:

{% if pre_job_template -%}{{ "  " | indent }}{% include pre_job_template.path %}{%- endif %}

  {%- if single_commit_check %}
  single_commit:
    name: Assert single commit
    if: github.ref == 'refs/heads/{{ plugin_default_branch }}'
    steps:
    - name: Checkout
      uses: actions/checkout@v1
      with:
        fetch-depth: 30
    - name: Checkout {{ plugin_default_branch }}
      run: git fetch origin {{ plugin_default_branch }}
    - name: create local {{ plugin_default_branch }} branch
      run: git branch {{ plugin_default_branch }} origin/{{ plugin_default_branch }}
    - name: Commit Count Check
      run: test `git log  --oneline --no-merges HEAD ^{{ plugin_default_branch }}  | wc -l ` = 1
    runs-on: ubuntu-latest
  {%- endif %}

  lint:
    runs-on: ubuntu-latest
    {% if pre_job_template %}needs: {{ pre_job_template.name }}{% endif %}

    steps:
      {{ checkout() | indent(6) }}

      {{ setup_python() | indent(6) }}

        # dev_requirements contains tools needed for flake8, etc.
      - name: Install requirements
        run: pip3 install -r dev_requirements.txt

      {% if check_commit_message -%}
      - name: Check commit message
        if: github.event_name == 'pull_request'
        env:
          {{ set_env_vars() | indent(10) }}
        run: sh .github/workflows/scripts/check_commit.sh
      {%- endif %}

      {% if black -%}
      # run black separately from flake8 to get a diff
      - name: Run black
        run: |
          black --version
          black --check --diff .
      {%- endif %}

      {% if flake8 -%}
      # Lint code.
      - name: Run flake8
        run: flake8 --config flake8.cfg
      {%- endif %}

      {% if check_manifest -%}
      # check for any files unintentionally left out of MANIFEST.in
      - name: Check manifest
        run: check-manifest
      {%- endif %}

      {% if check_stray_pulpcore_imports -%}
      - name: Check for pulpcore imports outside of pulpcore.plugin
        run: sh .ci/scripts/check_pulpcore_imports.sh
      {%- endif %}

      {% if check_gettext -%}
      - name: Check for gettext problems
        run: sh .ci/scripts/check_gettext.sh
      {%- endif %}

  test:
    runs-on: ubuntu-latest
    # run only after lint finishes
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        env:
          - TEST: pulp
          {%- if docs_test %}
          - TEST: docs
          {%- endif %}
          {%- if test_azure %}
          - TEST: azure
          {%- endif %}
          {%- if test_s3 %}
          - TEST: s3
          {%- endif %}
          {%- if test_bindings %}
          - TEST: bindings
          {%- endif %}

    steps:
      {{ checkout() | indent(6) }}

      {{ setup_python() | indent(6) }}

      {%- if test_bindings %}
      {{ setup_ruby() | indent(6) }}
      {%- endif %}

      {{ install_httpie() | indent(6) }}

      {{ run_script(name="Before Install", file="before_install.sh") | indent(6) }}

      {{ run_script(name="Install", file="install.sh") | indent(6) }}

      {{ run_script(name="Install Python client", file="install_python_client.sh", withenv=False) | indent(6) }}

      {{ run_script(name="Install Ruby client", file="install_ruby_client.sh", withenv=False, condition="${{ env.TEST == 'bindings' }}") | indent(6) }}

      {{ run_script(name="Before Script", file="before_script.sh") | indent(6) }}

      {{ set_secrets(condition="github.event_name != 'pull_request'") | indent(6) }}

      {{ run_script(name="Script", file="script.sh") | indent(6) }}

      {{ after_failure() | indent(6) }}

{%- if upgrade_range %}

  upgrade:
    runs-on: ubuntu-latest
    needs: lint

    {%- if upgrade_range is iterable and upgrade_range|length > 0 %}
    strategy:
      fail-fast: false
      matrix:
        env:
          - TEST: upgrade
        include:
        {%- for test in upgrade_range %}
          - FROM_PULPCORE_BRANCH: "{{ test.pulpcore_branch }}"
          {%- for plugin_branch, version in test.items() if plugin_branch != "pulpcore_branch" %}
            FROM_{{ plugin_branch| upper| replace("-", "_") }}: "{{version}}"
          {%- endfor %}
        {%- endfor %}
    {%- endif %}

    steps:
      {{ checkout() | indent(6) }}

      {{ setup_python() | indent(6) }}

      {{ install_httpie() | indent(6) }}

      {{ install_python_deps("wheel") | indent(6) }}

      {{ run_script(name="Before Install", file="before_install.sh") | indent(6) }}

      {{ run_script(name="Install", file="install.sh") | indent(6) }}

      {{ run_script(name="Install Python client", file="install_python_client.sh", withenv=False) | indent(6) }}

      {{ run_script(name="Before Script", file="before_script.sh") | indent(6) }}

      {{ set_secrets() | indent(6) }}

      {{ run_script(name="Upgrade Test", file="script.sh") | indent(6) }}

      {{ after_failure() | indent(6) }}
{%- endif %}


{% if post_job_template -%}{{ "  " | indent }}{% include post_job_template.path %}{%- endif %}
